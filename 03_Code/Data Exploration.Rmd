---
title: "Data Exploration"
output: html_document
---

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(leaflet)
library(sf)
```

```{r}
charging_points_raw<- read_csv("../01_Raw_Data/Electric_Vehicle_Charging_Points_2765336306591006216.csv")
charging_session_raw <- read_csv("../01_Raw_Data/EVChargeStationUseSept2018toAug2019.csv")

```

```{r}
cat("Charging Points Summary:\n")
glimpse(charging_points_raw)
cat("\nCharging Sessions Summary:\n")
glimpse(charging_session_raw)
```

```{r}
cat("\nMissing values in Charging Points:\n")
colSums(is.na(charging_points_raw))
cat("\nMissing values in Charging Sessions:\n")
colSums(is.na(charging_session_raw))
```

```{r}
# Convert to sf object, set CRS to EPSG:27700
charging_points_sf <- st_as_sf(charging_points_raw, coords = c("x", "y"), crs = 27700)

# Transform to WGS84 (longitude/latitude)
charging_points_latlon <- st_transform(charging_points_sf, 4326)

# Extract coordinates back to columns
coords <- st_coordinates(charging_points_latlon)
charging_points_latlon$lon <- coords[, 1]
charging_points_latlon$lat <- coords[, 2]
leaflet(data = charging_points_latlon) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 5,
    color = "blue",
    fillOpacity = 0.7,
    label = ~as.character(Id)
  ) %>%
  addLegend("bottomright", colors = "blue", labels = "Charging Points") %>%
  setView(lng = mean(charging_points_latlon$lon), lat = mean(charging_points_latlon$lat), zoom = 12)
```

```{r}
charging_session_raw <- charging_session_raw %>%
  rename(Id = `CP ID`)

usage_count <- charging_session_raw %>%
  count(Id, sort = TRUE) %>%
  rename(num_sessions = n)
```

```{r}
most_used_stations <- usage_count %>%
  left_join(charging_points_raw, by = "Id")
most_used_stations_clean <- most_used_stations %>%
  filter(!is.na(x) & !is.na(y))

# 2. Convert to lat/lon as before
most_used_stations_sf <- st_as_sf(most_used_stations_clean, coords = c("x", "y"), crs = 27700)
most_used_stations_latlon <- st_transform(most_used_stations_sf, 4326)
coords <- st_coordinates(most_used_stations_latlon)
most_used_stations_latlon$lon <- coords[, 1]
most_used_stations_latlon$lat <- coords[, 2]
pal <- colorNumeric(
  palette = "YlOrRd", 
  domain = most_used_stations_latlon$num_sessions
)
leaflet(data = most_used_stations_latlon) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addCircleMarkers(
    lng = ~lon, lat = ~lat,
    radius = 10,
    color = ~pal(num_sessions),
    fillOpacity = 0.7,
    label = ~paste("ID:", Id, "<br>Sessions:", num_sessions)
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~num_sessions,
    title = "Number of Sessions"
  ) %>%
  setView(
    lng = mean(most_used_stations_latlon$lon),
    lat = mean(most_used_stations_latlon$lat),
    zoom = 8
  )
```

```{r}
top10 <- usage_count %>% head(10)
ggplot(top10, aes(x = reorder(as.factor(Id), num_sessions), y = num_sessions)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(title = "Top 10 Most Used Charging Stations", x = "Charging Point ID", y = "Number of Sessions") +
  theme_minimal()
```

```{r}
library(lubridate)
charging_session_raw <- charging_session_raw %>%
  mutate(StartMonth = month(`Start Date`, label = TRUE))

# Plot
charging_session_raw %>%
  count(StartMonth) %>%
  ggplot(aes(x = StartMonth, y = n)) +
    geom_col(fill = "steelblue") +
    labs(title = "Sessions by Month", y = "Number of Sessions")
```

```{r}
charging_session_raw <- charging_session_raw %>%
  mutate(
    StartDateTime = ymd_hms(paste(`Start Date`, `Start Time`))
  )

charging_session_raw %>%
  mutate(hour = hour(StartDateTime)) %>%
  count(hour) %>%
  ggplot(aes(x = hour, y = n)) +
    geom_col(fill = "coral") +
    labs(title = "Charging Sessions by Hour of Day", x = "Hour", y = "Sessions")
```

-   charging session duration distribution

```{r}
charging_session_raw <- charging_session_raw %>%
  mutate(
    StartDateTime = ymd_hms(paste(`Start Date`, `Start Time`)),
    EndDateTime = ymd_hms(paste(`End Date`, `End Time`)),
    duration_minutes = as.numeric(difftime(EndDateTime, StartDateTime, units = "mins")),
    duration_hours = as.numeric(difftime(EndDateTime, StartDateTime, units = "hours"))
  )
charging_session_raw %>%
 # filter(duration_minutes > 0) %>%
  ggplot(aes(x = duration_minutes)) +
    geom_histogram(binwidth = 0.1, fill = "skyblue", color = "white") +
    scale_x_log10(
      breaks = c(1, 2, 5, 10, 20, 30, 60, 120, 240, 480, 1000),
      labels = c("1", "2", "5", "10", "20", "30", "60", "120", "240", "480", "1000")
  )+
    labs(
      title = "Distribution of Charging Session Durations (Log Scale)",
      x = "Duration (minutes, log10 scale)",
      y = "Number of Sessions"
    ) +
    theme_minimal()
```

```{r}
charging_session_raw %>%
  #filter(duration_minutes > 0, `Total kWh` > 0, `Total kWh`< 100) %>%
  ggplot(aes(x = `Total kWh`)) +
    geom_histogram(binwidth = 5, fill = "skyblue", color = "white")  + scale_x_continuous(
      breaks = seq(0, 300, 5)
    ) +
    labs(
      title = "Distribution of Delivered Charging Energy",
      x = "Energy delivered (kWh)",
      y = "Number of Sessions"
    ) + theme_minimal()
```

-\> I need to filter the sessions with \<0min; \> 1440 min (1 Day); kwh \< 0kWh; These sessions are most probably faulty.

```{}
```

-\> I need to filter the sessions with \<0min; \> 1440 min (1 Day); kwh \< 0kWh; These sessions are most probably faulty.

```{r}
charging_sessions_filtered <- charging_session_raw %>%
  mutate(
    StartDateTime = ymd_hms(paste(`Start Date`, `Start Time`)),
    EndDateTime   = ymd_hms(paste(`End Date`, `End Time`)),
    duration_minutes = as.numeric(difftime(EndDateTime, StartDateTime, units = "mins"))
  ) %>%
  filter(
    duration_minutes >= 0,       # remove negative durations
    duration_minutes <= 1440,    # remove sessions longer than 1 day
    `Total kWh` > 0                      # remove sessions with negative or zero kWh
  )

# Save to Processed folder
write_csv(charging_sessions_filtered, "../02_Processed_Data/charging_sessions_filtered.csv")
```

Top 10 Charging Station Boxplot; Brauche ich vermutlich nicht.

```{r}
charging_session_raw <- charging_session_raw %>%
  mutate(
    StartDateTime = ymd_hms(paste(`Start Date`, `Start Time`)),
    EndDateTime = ymd_hms(paste(`End Date`, `End Time`)),
    duration_minutes = as.numeric(difftime(EndDateTime, StartDateTime, units = "mins"))
  ) %>%
  filter(duration_minutes > 0, duration_minutes <= 1440)

filtered_data <- charging_session_raw %>%
  filter(duration_minutes <= quantile(duration_minutes, 0.99, na.rm = TRUE))

ggplot(filtered_data, aes(x = as.factor(Id), y = duration_minutes)) +
  geom_boxplot(outlier.alpha = 0.25, fill = "lightgreen") +
  labs(
    title = "Session Duration by Charging Station",
    x = "Charging Station",
    y = "Duration (minutes)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Feature Engineering:

1.  Time based & Location features already in the dataset;
2.  Mapping of shortest distance to the next station;
3.  Mapping of nearest Street classification (Bundesstraße, Landstraße...)
4.  mapping of nearest point of interest & the classification of it;
    1.  Supermarket; Highway station;
